language: node_js
node_js:
  - 10

python:
  - "3.4"

services:
  - mysql
  - mongodb
  - xvfb

addons:
  apt:
    packages:
      - nginx
      - python3-pip
      - libgconf-2-4

env:
  - API_URL=http://localhost:9000/metagenomics/api/v1/ SEARCH_URL=https://www.ebi.ac.uk/ebisearch/ws/rest/metagenomics_ EMG_CONFIG=$TRAVIS_BUILD_DIR/travis/config.yaml

before_install:
  # Setup for chrome
  - export DISPLAY=:99.0

  - pip3 install --user --upgrade pip setuptools
  - pip3 install --user --upgrade pip six==1.11.0
  - python3 -V
  - pip3 -V
  - pip3 install --user "git+git://github.com/EBI-metagenomics/django-rest-framework-json-api@develop#egg=djangorestframework-jsonapi"
  - pip3 install --user "git+git://github.com/EBI-metagenomics/emgapi@develop#egg=emgcli"

  # EMG API CONFIG MODIFICATION
  # Add slack notification to config
  - sed -i s#{SLACK_TOKEN}#$SLACK_TOKEN#g $TRAVIS_BUILD_DIR/travis/config.yaml

  # Inject travis build dir into nginx conf for location of downloads
  - sed -i s#{TRAVIS_BUILD_DIR}#$TRAVIS_BUILD_DIR#g $TRAVIS_BUILD_DIR/travis/nginx.conf

  ### TEST DATABASE SETUP
  # Create EMG and ENA user schemas
  - mysql -e 'CREATE DATABASE emg;'
  - mysql -e 'CREATE DATABASE ena;'
  - mysql -e "SET GLOBAL sql_mode = 'STRICT_TRANS_TABLES'"

  ## EMG SCHEMA
  # Create tables from django model
  - emgcli migrate

  # TEMPORARY fix for non-necessary primary keys in db
  - mysql -u root --password="" --database=emg < travis/temp_fix.sql

  # Join fixtures from multiple .sql files to populate db.
  - echo -e "SET FOREIGN_KEY_CHECKS = 0;\n$(cat travis/emg_sql_fixtures/*.sql)\nSET FOREIGN_KEY_CHECKS = 1;" > travis/emg_sql_fixtures/merged.sql
  - mysql -u root --password="" --database=emg < travis/emg_sql_fixtures/merged.sql

  ## EMG FIXTURES
  - travis/create_download_files.sh
  - emgcli import_taxonomy ERR1022502 ~/results
  - emgcli import_qc ERR1022502 ~/results
  - emgcli import_summary ERR1022502 ~/results .ipr
  - emgcli import_summary ERR1022502 ~/results .go_slim
  - emgcli import_summary ERR1022502 ~/results .go

  - emgcli import_taxonomy ERR867655 ~/results
  - emgcli import_qc ERR867655 ~/results
  - emgcli import_summary ERR867655 ~/results .ipr
  - emgcli import_summary ERR867655 ~/results .go_slim
  - emgcli import_summary ERR867655 ~/results .go

  - emgcli import_taxonomy ERP104236 ~/results
  - emgcli import_qc ERP104236 ~/results
  - emgcli import_summary ERP104236 ~/results .ipr
  - emgcli import_summary ERP104236 ~/results .go_slim
  - emgcli import_summary ERP104236 ~/results .go

  - emgcli import_kegg_brites $TRAVIS_BUILD_DIR/travis/emg_api_datafiles/kegg_orthology.json
  - emgcli import_genomes $TRAVIS_BUILD_DIR/travis/emg_api_datafiles/genomes/ 1.0

  ## ENA AUTHENTICATION FAKE DB
  # Create fake ENA authentication tables
  - mysql ena < $TRAVIS_BUILD_DIR/travis/ena_db.sql

  # Add backend auth package to path for emgapi
  - git clone https://github.com/EBI-Metagenomics/emgapi.git
  - export PYTHONPATH=/home/travis/build/EBI-Metagenomics/ebi-metagenomics-client/emgapi/tests/:$PYTHONPATH

  ## EMG API SETUP
  - emgcli collectstatic --noinput
  - emgcli check --deploy
  - emgdeploy --daemon -p ~/emg.pid emgcli.wsgi:application --workers 5

  ## NGINX SETUP
  - sudo chmod 777 /var/log/nginx/*
  - sudo chmod 777 /var/run/nginx.pid
  - nginx -c $TRAVIS_BUILD_DIR/travis/nginx.conf

install:
  # Install npm packages
  - npm install

script:
  - npm run test:single

after_success:
  - npm run coverage

deploy:
  provider: npm
  email: "metagenomics@ebi.ac.uk"
  api_key:
    secure: ha9B7YL2sB0m484FDXO0rimsxzmULrh+MJiC7qjlOimd8R6+xuPON9qf8TWuA7iFIyXvcXk7uunLABmJJjloKri/3sx5tFf2J0dPjiHZbc0yV2Bcds24wigqTaWCAjY0TKPmA090OjJnRjmSNtttVtp2NVUVQMtcs3DQWQJCZuBo8z6u4sVZ7myM/KL4ZzKOBwswO0LPg2qW3y3/AYZP9G5IdmQn1W7+XsEIMWAq8aJVOX9KQFvrR4Lx0Rc2wDKqGc1uqeGQDTkpbSpyaBDEp+EqF8MynN7KkgthVoKiyewakdPXTBirgY7mLItjOyISrSc8IzbAeF4yeYwmSY9XukskAP+bY5ci936PyDCpXgb2lygfvU3X+5ecNPiFegEzUl46FLDUIZDwNTu3H7HuQv0zVIZBJo0Pamcq1weBuG2foeqfJDoAhVUu0l+14xuAwkH3fq1FWT+vz44pYtdXZOJbQnJ5zddi+8q1Xc0pObUqbbKnPV7SFmOB4IfXFDmqK9iQST6n54ZMARau9ohj5SJYcJfMrXRxbEzDyw6dkROUOkz/g3sauc0w6x+6+99NXuBCW50Bj/yUA1Fxi79CQ6qFNTEhdFL7fwSfcSHhlbphpGO0N8rCThUlXhWPZIfOlMunnZ7No/ALi71Bci0J6aFLQkpKFC+sDcKSVYR/dmo=
  on:
    branch: master
    tag: next

cache:
  directories:
    - ~/.npm
    - ~/.cache